{"config":{"indexing":"full","lang":["en"],"min_search_length":3,"prebuild_index":false,"separator":"[\\s\\-]+"},"docs":[{"location":"","text":"BaBee: Agilicious Documentation for Autonomous Flying 1. Components List Component Model Main Compute Unit Nvidia Jetson Xavier NX 16 GB Module Breakout board A203 Carrier board for Jetson Nano/Xavier NX V2 Flight Controller SpeedyBee F7 V3 FC Electronic Speed Controller SpeedyBee BL32 50A 4-in-1 ESC Radio Receiver FS-X6B Radio Transmitter FS-16X Main Plate FPV Freestyle w/5mm arms Frame Motors TMotor F40 PRO V Motor Propellers TMotor T5147 POPO Racing Tri-Blade Propellers Battery Tattu R-Line 3.0 2000mAh 14.8V 120C 4S1P Lipo Battery Pack 2. Firmware List To follow our recommended process, you will need the following firmware: A Base Computer running Ubuntu 20.04, with installed: Motive (Mocap software) Betaflight (FC software - we recommend using a stable release) ROS A Babee Computer running Ubuntu 20.04, with installed: ROS 3. Mechanical Assembly The mechanical assembly of the quadrotor\u2019s frame (SpeedyBee Frame V2) can be done following this tutorial: Tutorial Link . 4. Flight Controller (FC) Electronic Assembly The electronic assembly of the flight controller (SV-F7V3-BL32-50A) can be done following the tutorials below: Tutorial 1 Tutorial 2 Tutorial 3 5. (Optional) Betaflight Software General Tutorials For those unused to Betaflight, we recommend watching the following playlist/series of videos, which explain in detail every aspect of the software and its configurations: Tutorial Playlist . 6. Flashing Jetson Xavier NX In order to flash Jetson Xavier NX on an A203 Carrier Board, you may want to follow the official instructions from the following link: Flashing Instructions . Note: We highly recommend not to flash using Nvidia\u2019s SDK Manager. Instead, we suggest using the command line installation steps from the above link. Jetson Linux Version: \u201c35.5.0 >\u201d JetPack version: \u201c5.0.2\u201d 7. (Optional) Betaflight Software for Remote Control Reminder that we use the Remote Controller FS-I6X Transmitter, and Receiver FS-X6B, where the below schematic applies: Remote Controller Flight Controller GND G 5V 4V5 PPM R2 Note that while PPM is working fine, iBUS is not recommended. The RC needs to be configured separately to unable arming on RC\u2019s end. For that, you can follow: Tutorial . Then, you must allow for communication between RC and FC. To do so, setup Betaflight\u2019s receiver configuration as in the below image: Finally, you may want to set up the Angle and Horizon mode under the Modes tab of Betaflight. 8. Hardware Connections SBUS has been used to connect FC (flight controller) and SBC (single board computer). Two distinct RX-TX pairs will be required on FC and SBC (you must not use the same X for RX/TX pairs). Solder the FC R2 and connect it to SBC USB-to-TTL cable on RX (note that the USB-to-TTL cable inverts RX and TX, therefore we connect R2 to USB_RX). Solder the FC T3 and connect it to SBC GPIO RX (UART_1; Pin 10, W8). Connect FC GND to SBC GPIO GND (Pin 6, W8). 9. Betaflight Software for Autonomous Flight a. Flashing (Tutorial - Link ) Go to \u201cFirmware Flasher\u201d Press \u201cAuto Detect\u201d to choose your flight controller. If it does not auto-detect, DO NOT FLASH and do research to find out what the correct target is. We recommend flashing on firmware 4.3.0. First, click \u201csave backup\u201d. The FC comes with some customization on it. If in the future, all the data is erased, your FC will go to default settings, which is not what we want. Load firmware online Flash Firmware Now on the top right, the menu should change to DFU mode. If it does not appear automatically, watch the video above. After flashing, press connect on the top right. Press \u201cApply Custom Defaults\u201d Press \u201cConnect \u201c again Betaflight might give some warnings now. Just follow the steps given. NOTE: NEVER click \u201cReset settings\u201d button in the \u201cSetup\u201d tab. This will reset the manufacturer\u2019s customization. This is not what you may want. b. Calibration In the Setup tab of Betaflight, click \u2018Calibrate Accelerometer\u2019 and follow the given instructions. c. Ports (Tutorial - Link ) Note that in each row, you can toggle at most one of the available settings (Configuration/MSP; Serial RX, Telemetry Output; Sensor Input; Peripherals). We set the following: i. USB VCP is by default set to MSP and should never be touched unless you know what you are doing. This would disable access to FC from USB-C connection and may require resetting the FC completely. ii. UART2\u2019s Serial RX to ON as R2 is used on the FC as a serial receiver. iii. UART3\u2019s Telemetry Output to MAVLink (communication protocol used by Mavros) with baud rate as 115200. iv. UART4\u2019s Sensor Input to ESC to allow communication from FC to ESC. d. Configuration (Tutorial - Link ) Our configuration tab is left (nearly) as default. A few minor changes have been done, such as the following: i. RX_LOST in Dshot Beacon Configuration may be set to ON/OFF based on your preference. Enabling this will enable a beeping sound when your FC does not receive any signal from a controller while armed. We have disabled this setting for convenience during testing. ii. Beacon Tone simply indicates which beeping sound you wish to use and is not important. e. Power&Battery (Tutorial - Link ) All parameters are left as default here. (Should we calibrate the battery? forgot) f. Receiver (Tutorial - Link ) Note that values in the Preview (left) tab might be different from one configuration to another. However, you must set the following: i. Receiver Mode is set to Serial (via UART) to allow serial communication via UARTs. ii. Serial Receiver Provider is set to SBUS as Agilicious uses SBUS to communicate. iii. Telemetry should be set ON to allow telemetry transmission from FC. iv. Channel Map is set to TAER1234 as required by Agilicious. g. Modes (Tutorial - Link ) i. We bind ARMing to AUX1 and set the enabling range from 1700 to 2100. This will allow Agilicious to arm the quadrotor. When first launching autonomous flying from Agilicious, you will observe AUX1 going to 1000 (unarmed). Then, when clicking \u2018Arm\u2019 in the software, the value will rise to 2000 and rotors will start spinning (armed). ii. Other modes can be configured here such as flying modes, beep signals\u2026 h. Motors (Tutorial - Link ) i. We recommend leaving ESC_SENSOR ON, although this may not affect autonomous flying. ii. We set Bidirectional DShot to ON to allow bidirectional communication between the FC and ESC. That is to send commands from FC to ESC (such as Motor Commands) and information signals from ESC to FC (such as Battery Voltage). iii. Then, you should set ESC/Motor Protocol to DSHOT600. iv. The value of Motor Poles depends on the number of magnets in each motor, our motors have 12 magnets each. v. You must configure your motors in the Motors section, such as setting up spacial configuration (here QuadX), motor indexing and spinning directions. i. CLI Tab The CLI is the command line dedicated to our FC configuration. To cope with Agilicious\u2019s setup, we must import their recommended internal configurations to our FC. To do so, we paste the below commands in our CLI. We recommend saving your current configuration given in our Github in betaflight_config file. 10.Mocap Setup Open Motive App Make sure no marker are detected Click \u201cStart Wanding\u201d Do the physical calibration When done click \u201cCalculate\u201d And apply the result if \u201cExcellent/Exceptional\u201d Set up the ground (initial coordinate) Select the ground on Motive Click \u201cSet ground plane\u201d Click \u201cExport\u201d Go to \u201cView\u201d > \u201cData Streaming Pane\u201d > \u201cStreaming\u201d > \u201cShow Advanced\u201d (if not automatic) Set \u201cUp Axis\u201d to \u201cZ Up\u201d Enable \u201cVRPN\u201d transmission/streaming In \u201cStreaming\u201d > \u201cLocal Interface\u201d select an IP (whichever you want, this will be used as the server address later) 11. Agilicious Installation First, we create two copies of the Agilicious repository. One should be for your local/base/host computer and the other will be on your SBC. Use the below commands to create/clone the clean copies on each computer: mkdir catkin_ws/src cd catkin_ws/src git clone https://github.com/catkin/catkin_simple git clone https://github.com/ethz-asl/mav_comm.git git clone git@github.com:uzh-rpg/agilicious.git catkin build 12.Demonstration You should now be ready to run the below demonstration on the Tracking Arena. Please note that, in the demonstration, we refer to the BSC as Babee. Demonstration for Tracking Arena: 1. Agilicious codebase configuration: On Babee: In onboard_pilot_betaflight.yaml change quadrotor to kingfisher, if not by default. In the file responsible for sending commands from NX->FC (here, sbus.yaml), change the TTY address to the one of the TX pin of the SBC (here, /dev/ttyUSB0). In the file responsible for receiving telemetry data from FC->NX (here, betaflight.launch), change the TTY address to the one of the RX pin of the SBC (here, /dev/ttyTHS0). On Base Computer: In arena_basecomputer_onboard.launch change the server address to the one of your Mocap system (for us, 10.206.0.244). By default, this will be: <param name=\"server\" value=\"192.168.200.119\"/>. 2. Setup before Launching: Before starting this setup, you must decide on which, Base Computer (BC) or Babee, you wish to set as your MASTER. This doesn\u2019t matter and can be either. We use BC. On Base Computer: Run the following commands in your BC terminal: cd catkin_ws/src/agilicious_internal/agiros/agiros/launch/tracking_arena source /opt/ros/noetic/setup.bash source ~/catkin_ws/devel/setup.bash export ROS_MASTER_URI=http://<MASTER_IP>:11311 export ROS_IP=<BC_IP> On Babee: Run the following commands in your Babee terminal: ssh@<Babee_IP> source /opt/ros/noetic/setup.bash source ~/catkin_ws/devel/setup.bash export ROS_MASTER_URI=http://<MASTER_IP>:11311 export ROS_IP=<Babee_IP> sudo systemctl stop serial-getty@ttyTHS0.service serial-getty@ttyUSB0.service sudo chmod a+rw /dev/ttyTHS* /dev/ttyUSB* sudo usermod -a -G dialout $USER 3. Launching: On Base Computer: launch the following file to start autonomous flying: roslaunch arena_base_computer_onboard.launch quad_name:=\u201dkingfisher\u201d This file will run 3 nodes: A GUI (to Connect, Arm and Hover) - This GUI is an alternative to RC. A VRPN Client (vrpn_client_ros) to get odometry data from the mocap. A Rviz instance to visualize everything. On Babee: launch the following file to start Autonomous flying: roslaunch arena_quadrotor_onboard_betaflight.launch quad_name:='kingfisher' This file will run 2 nodes: A Mavros (betaflight) instance. A Controller - which is either an MPC or PID, based on what is set in your configuration file in Agilicious codebase. By default Tracking Arena uses MPC. c. On the GUI (from Base Computer): If everything has been set up properly, when pressing Connect you should now see the Battery Voltage (indicating that FC-to-NX communication is working) and Odometry Data (indicating that data was successfully read from the Mocap system). Note that the Battery Voltage is now coming from the real hardware, so you must make sure that this value is correct (tips: if it is 15.5V, the telemetry communication probably failed). When clicking Arm motors should now be rotating (indicating that NX-to-FC communication is also working). When clicking Start, the motors should start spinning rapidly. Important: Make sure that the Stop button works before using the quadrotor with propellers on for safety reasons.","title":"BaBee: Agilicious Documentation for Autonomous Flying"},{"location":"#babee-agilicious-documentation-for-autonomous-flying","text":"","title":"BaBee: Agilicious Documentation for Autonomous Flying"},{"location":"#1-components-list","text":"Component Model Main Compute Unit Nvidia Jetson Xavier NX 16 GB Module Breakout board A203 Carrier board for Jetson Nano/Xavier NX V2 Flight Controller SpeedyBee F7 V3 FC Electronic Speed Controller SpeedyBee BL32 50A 4-in-1 ESC Radio Receiver FS-X6B Radio Transmitter FS-16X Main Plate FPV Freestyle w/5mm arms Frame Motors TMotor F40 PRO V Motor Propellers TMotor T5147 POPO Racing Tri-Blade Propellers Battery Tattu R-Line 3.0 2000mAh 14.8V 120C 4S1P Lipo Battery Pack","title":"1. Components List"},{"location":"#2-firmware-list","text":"To follow our recommended process, you will need the following firmware: A Base Computer running Ubuntu 20.04, with installed: Motive (Mocap software) Betaflight (FC software - we recommend using a stable release) ROS A Babee Computer running Ubuntu 20.04, with installed: ROS","title":"2. Firmware List"},{"location":"#3-mechanical-assembly","text":"The mechanical assembly of the quadrotor\u2019s frame (SpeedyBee Frame V2) can be done following this tutorial: Tutorial Link .","title":"3. Mechanical Assembly"},{"location":"#4-flight-controller-fc-electronic-assembly","text":"The electronic assembly of the flight controller (SV-F7V3-BL32-50A) can be done following the tutorials below: Tutorial 1 Tutorial 2 Tutorial 3","title":"4. Flight Controller (FC) Electronic Assembly"},{"location":"#5-optional-betaflight-software-general-tutorials","text":"For those unused to Betaflight, we recommend watching the following playlist/series of videos, which explain in detail every aspect of the software and its configurations: Tutorial Playlist .","title":"5. (Optional) Betaflight Software General Tutorials"},{"location":"#6-flashing-jetson-xavier-nx","text":"In order to flash Jetson Xavier NX on an A203 Carrier Board, you may want to follow the official instructions from the following link: Flashing Instructions . Note: We highly recommend not to flash using Nvidia\u2019s SDK Manager. Instead, we suggest using the command line installation steps from the above link. Jetson Linux Version: \u201c35.5.0 >\u201d JetPack version: \u201c5.0.2\u201d","title":"6. Flashing Jetson Xavier NX"},{"location":"#7-optional-betaflight-software-for-remote-control","text":"Reminder that we use the Remote Controller FS-I6X Transmitter, and Receiver FS-X6B, where the below schematic applies: Remote Controller Flight Controller GND G 5V 4V5 PPM R2 Note that while PPM is working fine, iBUS is not recommended. The RC needs to be configured separately to unable arming on RC\u2019s end. For that, you can follow: Tutorial . Then, you must allow for communication between RC and FC. To do so, setup Betaflight\u2019s receiver configuration as in the below image: Finally, you may want to set up the Angle and Horizon mode under the Modes tab of Betaflight.","title":"7. (Optional) Betaflight Software for Remote Control"},{"location":"#8-hardware-connections","text":"SBUS has been used to connect FC (flight controller) and SBC (single board computer). Two distinct RX-TX pairs will be required on FC and SBC (you must not use the same X for RX/TX pairs). Solder the FC R2 and connect it to SBC USB-to-TTL cable on RX (note that the USB-to-TTL cable inverts RX and TX, therefore we connect R2 to USB_RX). Solder the FC T3 and connect it to SBC GPIO RX (UART_1; Pin 10, W8). Connect FC GND to SBC GPIO GND (Pin 6, W8).","title":"8. Hardware Connections"},{"location":"#9-betaflight-software-for-autonomous-flight","text":"","title":"9. Betaflight Software for Autonomous Flight"},{"location":"#a-flashing-tutorial-link","text":"Go to \u201cFirmware Flasher\u201d Press \u201cAuto Detect\u201d to choose your flight controller. If it does not auto-detect, DO NOT FLASH and do research to find out what the correct target is. We recommend flashing on firmware 4.3.0. First, click \u201csave backup\u201d. The FC comes with some customization on it. If in the future, all the data is erased, your FC will go to default settings, which is not what we want. Load firmware online Flash Firmware Now on the top right, the menu should change to DFU mode. If it does not appear automatically, watch the video above. After flashing, press connect on the top right. Press \u201cApply Custom Defaults\u201d Press \u201cConnect \u201c again Betaflight might give some warnings now. Just follow the steps given. NOTE: NEVER click \u201cReset settings\u201d button in the \u201cSetup\u201d tab. This will reset the manufacturer\u2019s customization. This is not what you may want.","title":"a. Flashing (Tutorial - Link)"},{"location":"#b-calibration","text":"In the Setup tab of Betaflight, click \u2018Calibrate Accelerometer\u2019 and follow the given instructions.","title":"b. Calibration"},{"location":"#c-ports-tutorial-link","text":"Note that in each row, you can toggle at most one of the available settings (Configuration/MSP; Serial RX, Telemetry Output; Sensor Input; Peripherals). We set the following: i. USB VCP is by default set to MSP and should never be touched unless you know what you are doing. This would disable access to FC from USB-C connection and may require resetting the FC completely. ii. UART2\u2019s Serial RX to ON as R2 is used on the FC as a serial receiver. iii. UART3\u2019s Telemetry Output to MAVLink (communication protocol used by Mavros) with baud rate as 115200. iv. UART4\u2019s Sensor Input to ESC to allow communication from FC to ESC.","title":"c. Ports (Tutorial - Link)"},{"location":"#d-configuration-tutorial-link","text":"Our configuration tab is left (nearly) as default. A few minor changes have been done, such as the following: i. RX_LOST in Dshot Beacon Configuration may be set to ON/OFF based on your preference. Enabling this will enable a beeping sound when your FC does not receive any signal from a controller while armed. We have disabled this setting for convenience during testing. ii. Beacon Tone simply indicates which beeping sound you wish to use and is not important.","title":"d. Configuration (Tutorial - Link)"},{"location":"#e-powerbattery-tutorial-link","text":"All parameters are left as default here. (Should we calibrate the battery? forgot)","title":"e. Power&amp;Battery (Tutorial - Link)"},{"location":"#f-receiver-tutorial-link","text":"Note that values in the Preview (left) tab might be different from one configuration to another. However, you must set the following: i. Receiver Mode is set to Serial (via UART) to allow serial communication via UARTs. ii. Serial Receiver Provider is set to SBUS as Agilicious uses SBUS to communicate. iii. Telemetry should be set ON to allow telemetry transmission from FC. iv. Channel Map is set to TAER1234 as required by Agilicious.","title":"f. Receiver (Tutorial - Link)"},{"location":"#g-modes-tutorial-link","text":"i. We bind ARMing to AUX1 and set the enabling range from 1700 to 2100. This will allow Agilicious to arm the quadrotor. When first launching autonomous flying from Agilicious, you will observe AUX1 going to 1000 (unarmed). Then, when clicking \u2018Arm\u2019 in the software, the value will rise to 2000 and rotors will start spinning (armed). ii. Other modes can be configured here such as flying modes, beep signals\u2026","title":"g. Modes (Tutorial - Link)"},{"location":"#h-motors-tutorial-link","text":"i. We recommend leaving ESC_SENSOR ON, although this may not affect autonomous flying. ii. We set Bidirectional DShot to ON to allow bidirectional communication between the FC and ESC. That is to send commands from FC to ESC (such as Motor Commands) and information signals from ESC to FC (such as Battery Voltage). iii. Then, you should set ESC/Motor Protocol to DSHOT600. iv. The value of Motor Poles depends on the number of magnets in each motor, our motors have 12 magnets each. v. You must configure your motors in the Motors section, such as setting up spacial configuration (here QuadX), motor indexing and spinning directions.","title":"h. Motors (Tutorial - Link)"},{"location":"#i-cli-tab","text":"The CLI is the command line dedicated to our FC configuration. To cope with Agilicious\u2019s setup, we must import their recommended internal configurations to our FC. To do so, we paste the below commands in our CLI. We recommend saving your current configuration given in our Github in betaflight_config file.","title":"i. CLI Tab"},{"location":"#10mocap-setup","text":"Open Motive App Make sure no marker are detected Click \u201cStart Wanding\u201d Do the physical calibration When done click \u201cCalculate\u201d And apply the result if \u201cExcellent/Exceptional\u201d Set up the ground (initial coordinate) Select the ground on Motive Click \u201cSet ground plane\u201d Click \u201cExport\u201d Go to \u201cView\u201d > \u201cData Streaming Pane\u201d > \u201cStreaming\u201d > \u201cShow Advanced\u201d (if not automatic) Set \u201cUp Axis\u201d to \u201cZ Up\u201d Enable \u201cVRPN\u201d transmission/streaming In \u201cStreaming\u201d > \u201cLocal Interface\u201d select an IP (whichever you want, this will be used as the server address later)","title":"10.Mocap Setup"},{"location":"#11-agilicious-installation","text":"First, we create two copies of the Agilicious repository. One should be for your local/base/host computer and the other will be on your SBC. Use the below commands to create/clone the clean copies on each computer: mkdir catkin_ws/src cd catkin_ws/src git clone https://github.com/catkin/catkin_simple git clone https://github.com/ethz-asl/mav_comm.git git clone git@github.com:uzh-rpg/agilicious.git catkin build","title":"11. Agilicious Installation"},{"location":"#12demonstration","text":"You should now be ready to run the below demonstration on the Tracking Arena. Please note that, in the demonstration, we refer to the BSC as Babee. Demonstration for Tracking Arena:","title":"12.Demonstration"},{"location":"#1-agilicious-codebase-configuration","text":"On Babee: In onboard_pilot_betaflight.yaml change quadrotor to kingfisher, if not by default. In the file responsible for sending commands from NX->FC (here, sbus.yaml), change the TTY address to the one of the TX pin of the SBC (here, /dev/ttyUSB0). In the file responsible for receiving telemetry data from FC->NX (here, betaflight.launch), change the TTY address to the one of the RX pin of the SBC (here, /dev/ttyTHS0). On Base Computer: In arena_basecomputer_onboard.launch change the server address to the one of your Mocap system (for us, 10.206.0.244). By default, this will be: <param name=\"server\" value=\"192.168.200.119\"/>.","title":"1. Agilicious codebase configuration:"},{"location":"#2-setup-before-launching","text":"Before starting this setup, you must decide on which, Base Computer (BC) or Babee, you wish to set as your MASTER. This doesn\u2019t matter and can be either. We use BC. On Base Computer: Run the following commands in your BC terminal: cd catkin_ws/src/agilicious_internal/agiros/agiros/launch/tracking_arena source /opt/ros/noetic/setup.bash source ~/catkin_ws/devel/setup.bash export ROS_MASTER_URI=http://<MASTER_IP>:11311 export ROS_IP=<BC_IP> On Babee: Run the following commands in your Babee terminal: ssh@<Babee_IP> source /opt/ros/noetic/setup.bash source ~/catkin_ws/devel/setup.bash export ROS_MASTER_URI=http://<MASTER_IP>:11311 export ROS_IP=<Babee_IP> sudo systemctl stop serial-getty@ttyTHS0.service serial-getty@ttyUSB0.service sudo chmod a+rw /dev/ttyTHS* /dev/ttyUSB* sudo usermod -a -G dialout $USER","title":"2. Setup before Launching:"},{"location":"#3-launching","text":"On Base Computer: launch the following file to start autonomous flying: roslaunch arena_base_computer_onboard.launch quad_name:=\u201dkingfisher\u201d This file will run 3 nodes: A GUI (to Connect, Arm and Hover) - This GUI is an alternative to RC. A VRPN Client (vrpn_client_ros) to get odometry data from the mocap. A Rviz instance to visualize everything. On Babee: launch the following file to start Autonomous flying: roslaunch arena_quadrotor_onboard_betaflight.launch quad_name:='kingfisher' This file will run 2 nodes: A Mavros (betaflight) instance. A Controller - which is either an MPC or PID, based on what is set in your configuration file in Agilicious codebase. By default Tracking Arena uses MPC. c. On the GUI (from Base Computer): If everything has been set up properly, when pressing Connect you should now see the Battery Voltage (indicating that FC-to-NX communication is working) and Odometry Data (indicating that data was successfully read from the Mocap system). Note that the Battery Voltage is now coming from the real hardware, so you must make sure that this value is correct (tips: if it is 15.5V, the telemetry communication probably failed). When clicking Arm motors should now be rotating (indicating that NX-to-FC communication is also working). When clicking Start, the motors should start spinning rapidly. Important: Make sure that the Stop button works before using the quadrotor with propellers on for safety reasons.","title":"3. Launching:"}]}